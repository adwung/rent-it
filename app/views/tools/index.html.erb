<h2>Tool Search Result</h2>
<h3><i class="fa fa-angle-double-right" aria-hidden="true"></i><%= pluralize @filtered_result.count, 'item' %> found</h3>
<div id="filter_bys">

  <header>Filter Result:</header>
  <div class="row">
    <div class="col-md-4 col-xs-6">
        <div class="filter_by">
            <label for="filter_by_category_name">Category: </label>
            <select id="filter_by_category_name">
            <option value="all">Show all categories</option>
            <% @categories.each do |category| %>
                <option value="<%= category.name %>"><%= category.name %></option>
            <% end %>
            </select>
        </div>
    </div>
    <div class="col-md-4 col-xs-6">
        <div class="filter_by">
            <label for="filter_by_distance">Distance: </label>
            <select id="filter_by_distance">
            <option value="5">5 km</option>
            <option value="10">10 km</option>
            <option value="15">15 km</option>
            <option value="25">25 km</option>
            <option value="50" selected="selected">50 km</option>
            <option value="100">100 km</option>
            </select>
        </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6 col-xs-12 no-padding">
    <div class="tools"> 
    <% @filtered_result.each do |tool| %>
      <div class="row">
        <div class="tool">
          <div class="col-md-3 col-xs-4">
            <%= image_tag tool.picture.tiny %>
          </div>
          <div class="col-md-6 col-xs-4">
            <div class="row"><h5>Name: <%= tool.name %></h5></div>
            <div class="col-6">
              <i class="fa fa-usd" aria-hidden="true"></i>
              <%= humanized_money tool.daily_rate %> (daily)
            </div>
            <div class="col-6">
              <% if @lat && @lng %>
              <i class="fa fa-location-arrow" aria-hidden="true"></i>
              <span class="distance">
                  <%= tool.distance_to([@lat, @lng]).round (2) %>
              </span> km (aprox)
            <% end %>
            </div>

          </div>
          <div class="col-md-3">
            <div class="row">
              <% if current_user %>
                  <%= link_to add_item_cart_path(tool_id: tool.id), method: :put, class: 'add-to-cart' do %>
                    Add to cart <i class="fa fa-shopping-basket" aria-hidden="true"></i>
                  <% end %>
              <% end %>
            </div>
            <div class="row"><%= link_to 'Details', tool, target: '_blank' %></div>
          </div>
        </div>
      </div>
    <% end %>
      <h3>aaaa</h3>
      <h3>aaaa</h3>
      <h3>aaaa</h3>
      <h3>aaaa</h3>
      <h3>aaaa</h3>
      <h3>aaaa</h3>
    </div>
  </div>
  <div class="col-md-6 col-lg-6 col-xs-12 no-padding">
    <div id="map"></div>
  </div>
</div>

<style>
  #map {
    height: 400px;
    width: 80%;
    margin: 0 auto;
  }
</style>


<script type="text/javascript" charset="utf-8">
    $(document).ready(function () {

        var $tools = $('.tool');

        function sort_tools($sort_by_value) {
            $tools.sort(function (a, b) {
                var an = $(a).find('.' + $sort_by_value).text();
                var bn = $(b).find('.' + $sort_by_value).text();
                if (an > bn) {
                    return 1;
                }
                if (an < bn) {
                    return -1;
                }
                return 0;
            });
        }

        function filter_tools_by_category(category_name) {
            if (category_name === 'all') {
                return $tools;
            } else {
                var $filtered_tools = $tools.filter(function (index) {
                    return $($tools[index]).find('.category').text() === category_name
                });
                return $filtered_tools;
            }
        }

        function filter_tools_by_distance(distance) {
            if (distance === 'all') {
                return $tools
            } else {
                var $filtered_tools = $tools.filter(function (index) {
                    return Number($($tools[index]).find('.distance').text()) <= Number(distance)
                });
                return $filtered_tools
            }
        }

        function filter_tools() {
            var category_name = $('#filter_by_category_name').val();
            var distance = $('#filter_by_distance').val();
            if (category_name === 'all') {
                return $tools.filter(function (index) {
                    return Number($($tools[index]).find('.distance').text()) <= Number(distance)
                });
            } else {
                var $filtered_tools_by_distance = $tools.filter(function (index) {
                    return Number($($tools[index]).find('.distance').text()) <= Number(distance)
                });
                // Filter again by category
                return $filtered_tools_by_distance.filter(function (index) {
                    return $($filtered_tools_by_distance[index]).find('.category').text() === category_name
                });
            }
        }

        function render() {
            $tools.hide();
            var $result = filter_tools();
            $result.show();
        }

        render();
        $('.filter_by').change(function () {
            render();
        })
    });
    function initMap() {
        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 11,
            center: {lat: gon.result[0].lat, lng: gon.result[0].lng}
        });

        const tools = gon.result;

        let infowindow = null;

        for (let i in tools) {
            let tool = tools[i];
            let marker = new google.maps.Marker({
                position: {
                    lat: Number(tool.lat),
                    lng: Number(tool.lng)
                },
                map: map
            });


            let content = `<img src="${tool.picture.tiny.url}"><ul><li>${tool.name}</li><li>${tool.street_address}</li></ul>`;

            google.maps.event.addListener(marker, 'click', function() {
                if (infowindow) {
                    infowindow.close();
                }

                infowindow = new google.maps.InfoWindow({
                    content: content
                });

                infowindow.open(map, marker);

            });
        }

    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyC2pWNHJAhzOEtqohWE1mD1tvTLXQfBQLI&callback=initMap"></script>
